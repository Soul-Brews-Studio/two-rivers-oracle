<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Library Data Analysis — สองแคว Workshop</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0d1117; color: #e6edf3; font-family: -apple-system, 'Noto Sans Thai', sans-serif; overflow-x: hidden; }

  .layout { display: grid; grid-template-columns: 280px 1fr 300px; gap: 12px; padding: 12px; min-height: 100vh; }
  @media (max-width: 900px) { .layout { grid-template-columns: 1fr; height: auto; } }

  .panel {
    background: #161b22; border: 1px solid #30363d; border-radius: 12px;
    padding: 16px; overflow-y: auto;
  }
  .panel h2 { color: #58a6ff; font-size: 1rem; margin-bottom: 8px; }
  .panel h3 { color: #8b949e; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin: 12px 0 6px; }

  /* Controls */
  label.ctrl { display: block; font-size: 0.75rem; color: #8b949e; margin: 8px 0 2px; }
  select, input[type="date"] {
    width: 100%; padding: 8px 10px; background: #0d1117; border: 1px solid #30363d;
    border-radius: 6px; color: #e6edf3; font-size: 0.85rem;
  }
  select option { background: #0d1117; }

  /* Status */
  .status-row { display: flex; align-items: center; gap: 6px; margin: 4px 0; font-size: 0.75rem; }
  .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .dot.on { background: #3fb950; box-shadow: 0 0 4px #3fb950; }
  .dot.off { background: #f87171; }
  .dot.wait { background: #f0883e; animation: pulse 1.5s infinite; }
  @keyframes pulse { 50% { opacity: 0.4; } }

  /* Heatmap */
  .heatmap-wrap {
    background: #0d1117; border: 1px solid #30363d; border-radius: 8px;
    padding: 12px; margin-bottom: 12px; overflow-x: auto;
  }
  .heatmap-wrap canvas { display: block; cursor: crosshair; }
  .heatmap-tooltip {
    display: none; position: fixed; background: #21262d; border: 1px solid #58a6ff;
    border-radius: 6px; padding: 8px 12px; font-size: 0.8rem; pointer-events: none; z-index: 100;
  }

  /* Chart */
  .chart-wrap { position: relative; height: 200px; margin-bottom: 12px; }

  /* Stats */
  .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 8px 0; }
  .stat-card {
    background: #0d1117; border: 1px solid #30363d; border-radius: 8px;
    padding: 10px; text-align: center;
  }
  .stat-card .num { font-size: 1.4rem; font-weight: 700; }
  .stat-card .lbl { font-size: 0.65rem; color: #8b949e; margin-top: 2px; }
  .stat-card.green .num { color: #3fb950; }
  .stat-card.red .num { color: #f87171; }
  .stat-card.yellow .num { color: #fbbf24; }
  .stat-card.blue .num { color: #58a6ff; }
  .stat-card.purple .num { color: #bc8cff; }
  .stat-card.cyan .num { color: #39d5ff; }

  /* Recommendation cards */
  .rec-card {
    background: #0d1117; border: 1px solid #30363d; border-radius: 8px;
    padding: 10px; margin: 6px 0; cursor: pointer; transition: border-color 0.2s;
  }
  .rec-card:hover { border-color: #58a6ff; }
  .rec-card.active { border-color: #58a6ff; background: #1f3a5f22; }
  .rec-card .title { color: #e6edf3; font-size: 0.85rem; font-weight: 600; }
  .rec-card .meta { color: #8b949e; font-size: 0.7rem; margin-top: 2px; }

  /* Recommendation results */
  .rec-result {
    background: #21262d; border-left: 3px solid #3fb950; border-radius: 4px;
    padding: 8px 10px; margin: 4px 0; font-size: 0.8rem;
  }
  .rec-result .score { color: #3fb950; font-size: 0.7rem; }

  /* AI Insight */
  .insight-card {
    background: #0d1117; border: 1px solid #30363d; border-radius: 8px;
    padding: 12px; margin: 6px 0; border-left: 3px solid #bc8cff;
  }
  .insight-card .icon { font-size: 0.7rem; color: #bc8cff; text-transform: uppercase; font-weight: 600; margin-bottom: 4px; }
  .insight-card .text { font-size: 0.8rem; color: #e6edf3; line-height: 1.4; }

  /* Feed */
  .feed { max-height: 180px; overflow-y: auto; font-size: 0.7rem; font-family: monospace; }
  .feed-entry { padding: 3px 6px; border-bottom: 1px solid #21262d; display: flex; gap: 8px; }
  .feed-entry .ts { color: #484f58; flex-shrink: 0; }
  .feed-entry .cat { color: #58a6ff; min-width: 60px; }
  .feed-entry .count { color: #3fb950; }

  /* Apply button */
  .apply-btn {
    width: 100%; padding: 10px; margin-top: 12px; border: none; border-radius: 8px;
    font-size: 0.9rem; font-weight: 700; cursor: pointer;
    background: #58a6ff; color: #0d1117;
  }
  .apply-btn:hover { background: #79b8ff; }

  /* Faculty tags */
  .faculty-tag {
    display: inline-block; padding: 4px 8px; margin: 2px; border: 1px solid #30363d;
    border-radius: 12px; font-size: 0.7rem; color: #8b949e; cursor: pointer; transition: all 0.15s;
  }
  .faculty-tag:hover { border-color: #58a6ff; }
  .faculty-tag.active { background: #1f3a5f; border-color: #58a6ff; color: #58a6ff; }

  /* Header bar */
  .header {
    grid-column: 1 / -1; display: flex; align-items: center; gap: 12px;
    padding: 8px 16px; background: #161b22; border: 1px solid #30363d; border-radius: 12px;
  }
  .header h1 {
    font-size: 1.2rem;
    background: linear-gradient(135deg, #58a6ff, #3fb950);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .header .sub { color: #8b949e; font-size: 0.75rem; }
  .header .links { margin-left: auto; font-size: 0.7rem; }
  .header .links a { color: #58a6ff; text-decoration: none; margin-left: 12px; }
</style>
</head>
<body>

<div class="layout">
  <!-- Header -->
  <div class="header">
    <h1>Library Data Analysis</h1>
    <span class="sub">วิเคราะห์การยืมหนังสือห้องสมุด PSRU</span>
    <div class="links">
      <a href="index.html">Workshop</a>
      <a href="arena.html">Arena</a>
      <a href="https://github.com/Soul-Brews-Studio/two-rivers-oracle">GitHub</a>
    </div>
  </div>

  <!-- LEFT: Filters -->
  <div class="panel" id="controls-panel">
    <h2>Filters</h2>
    <div class="status-row"><div class="dot wait" id="dot-mqtt"></div><span id="status-mqtt">mqtt: connecting...</span></div>

    <label class="ctrl">Category / หมวดหมู่</label>
    <select id="sel-category">
      <option value="all">ทั้งหมด</option>
      <option value="it">IT / คอมพิวเตอร์</option>
      <option value="engineering">วิศวกรรม</option>
      <option value="science">วิทยาศาสตร์</option>
      <option value="language">ภาษา</option>
      <option value="arts">ศิลปะ / มนุษยศาสตร์</option>
      <option value="education">ครุศาสตร์</option>
    </select>

    <label class="ctrl">Date Range / ช่วงวันที่</label>
    <input type="date" id="date-start" value="2025-01-01">
    <input type="date" id="date-end" value="2025-12-31" style="margin-top:4px;">

    <h3>Faculty / คณะ</h3>
    <div id="faculty-tags">
      <span class="faculty-tag active" data-fac="all">ทั้งหมด</span>
      <span class="faculty-tag" data-fac="science">วิทยาศาสตร์</span>
      <span class="faculty-tag" data-fac="engineering">เทคโนโลยี</span>
      <span class="faculty-tag" data-fac="education">ครุศาสตร์</span>
      <span class="faculty-tag" data-fac="humanities">มนุษยศาสตร์</span>
      <span class="faculty-tag" data-fac="management">วิทยาการจัดการ</span>
      <span class="faculty-tag" data-fac="agri">เกษตร</span>
    </div>

    <button class="apply-btn" onclick="applyFilters()">Apply Filters</button>

    <h3>Popular Books / หนังสือยอดนิยม</h3>
    <div id="book-list"></div>
  </div>

  <!-- CENTER: Heatmap + Charts -->
  <div class="panel">
    <h2>Borrowing Heatmap — ช่วงเวลายืม</h2>
    <div class="heatmap-wrap">
      <canvas id="heatmap" width="660" height="230"></canvas>
    </div>
    <div class="heatmap-tooltip" id="heatmap-tip"></div>

    <h2>Borrowing by Category</h2>
    <div class="chart-wrap"><canvas id="chart-bar"></canvas></div>

    <h2>Monthly Trend — แนวโน้มรายเดือน</h2>
    <div class="chart-wrap"><canvas id="chart-line"></canvas></div>

    <h3>Query Feed</h3>
    <div class="feed" id="feed"></div>
  </div>

  <!-- RIGHT: Recommendations + AI + Stats -->
  <div class="panel">
    <h2>Stats / สถิติ</h2>
    <div class="stat-grid">
      <div class="stat-card blue"><div class="num" id="s-total">12,847</div><div class="lbl">Total Books</div></div>
      <div class="stat-card green"><div class="num" id="s-borrowers">3,241</div><div class="lbl">Active Borrowers</div></div>
      <div class="stat-card yellow"><div class="num" id="s-popular">IT</div><div class="lbl">Most Popular</div></div>
      <div class="stat-card purple"><div class="num" id="s-duration">8.3d</div><div class="lbl">Avg Duration</div></div>
      <div class="stat-card cyan"><div class="num" id="s-recs">0</div><div class="lbl">Recs Made</div></div>
      <div class="stat-card green"><div class="num" id="s-insights">0</div><div class="lbl">AI Insights</div></div>
    </div>

    <h3>AI Insights</h3>
    <div id="insight-panel"></div>

    <h3>Recommendations / แนะนำ</h3>
    <div id="rec-panel">
      <div style="font-size:0.75rem; color:#8b949e;">Click a book on the left to see recommendations</div>
    </div>
  </div>
</div>

<script>
// ===== CONSTANTS =====
const MQTT_BROKER = 'wss://dustboy-wss-bridge.laris.workers.dev/mqtt';
const DAYS_TH = ['จันทร์','อังคาร','พุธ','พฤหัสบดี','ศุกร์','เสาร์','อาทิตย์'];
const HOURS = Array.from({length:12}, (_,i) => (8+i)+':00');
const CATEGORIES = {
  it: 'IT / คอมพิวเตอร์',
  engineering: 'วิศวกรรม',
  science: 'วิทยาศาสตร์',
  language: 'ภาษา',
  arts: 'ศิลปะ',
  education: 'ครุศาสตร์'
};
const CAT_COLORS = {
  it: '#58a6ff', engineering: '#f0883e', science: '#3fb950',
  language: '#bc8cff', arts: '#f87171', education: '#fbbf24'
};

// ===== MOCK DATA =====
const BOOKS = [
  { id: 1, title: 'Python สำหรับวิทยาศาสตร์ข้อมูล', cat: 'it', borrows: 234, faculty: 'science' },
  { id: 2, title: 'ปัญญาประดิษฐ์เบื้องต้น', cat: 'it', borrows: 198, faculty: 'science' },
  { id: 3, title: 'Machine Learning ภาคปฏิบัติ', cat: 'it', borrows: 187, faculty: 'engineering' },
  { id: 4, title: 'Web Development ด้วย React', cat: 'it', borrows: 165, faculty: 'engineering' },
  { id: 5, title: 'วิศวกรรมซอฟต์แวร์', cat: 'engineering', borrows: 156, faculty: 'engineering' },
  { id: 6, title: 'ฟิสิกส์ทั่วไป เล่ม 1', cat: 'science', borrows: 148, faculty: 'science' },
  { id: 7, title: 'แคลคูลัส', cat: 'science', borrows: 142, faculty: 'science' },
  { id: 8, title: 'ภาษาอังกฤษเพื่อการสื่อสาร', cat: 'language', borrows: 137, faculty: 'humanities' },
  { id: 9, title: 'จิตวิทยาการศึกษา', cat: 'education', borrows: 128, faculty: 'education' },
  { id: 10, title: 'การออกแบบกราฟิก', cat: 'arts', borrows: 119, faculty: 'humanities' },
  { id: 11, title: 'IoT และ Embedded Systems', cat: 'it', borrows: 112, faculty: 'engineering' },
  { id: 12, title: 'สถิติเบื้องต้น', cat: 'science', borrows: 105, faculty: 'science' },
  { id: 13, title: 'Database Management', cat: 'it', borrows: 98, faculty: 'engineering' },
  { id: 14, title: 'ภาษาจีนเบื้องต้น', cat: 'language', borrows: 91, faculty: 'humanities' },
  { id: 15, title: 'การจัดการโครงการ', cat: 'engineering', borrows: 85, faculty: 'management' },
  { id: 16, title: 'Blockchain และ Cryptocurrency', cat: 'it', borrows: 78, faculty: 'engineering' },
  { id: 17, title: 'เกษตรอินทรีย์', cat: 'science', borrows: 72, faculty: 'agri' },
  { id: 18, title: 'การวิจัยเชิงคุณภาพ', cat: 'education', borrows: 67, faculty: 'education' },
  { id: 19, title: 'ศิลปะร่วมสมัย', cat: 'arts', borrows: 61, faculty: 'humanities' },
  { id: 20, title: 'Cybersecurity เบื้องต้น', cat: 'it', borrows: 55, faculty: 'engineering' },
];

const RECOMMENDATIONS = {
  1: [
    { title: 'Machine Learning ภาคปฏิบัติ', score: 0.94 },
    { title: 'สถิติเบื้องต้น', score: 0.87 },
    { title: 'ปัญญาประดิษฐ์เบื้องต้น', score: 0.85 },
    { title: 'Database Management', score: 0.72 },
  ],
  2: [
    { title: 'Machine Learning ภาคปฏิบัติ', score: 0.96 },
    { title: 'Python สำหรับวิทยาศาสตร์ข้อมูล', score: 0.91 },
    { title: 'IoT และ Embedded Systems', score: 0.78 },
  ],
  3: [
    { title: 'ปัญญาประดิษฐ์เบื้องต้น', score: 0.93 },
    { title: 'Python สำหรับวิทยาศาสตร์ข้อมูล', score: 0.90 },
    { title: 'สถิติเบื้องต้น', score: 0.82 },
    { title: 'Database Management', score: 0.68 },
  ],
  4: [
    { title: 'การออกแบบกราฟิก', score: 0.81 },
    { title: 'Database Management', score: 0.79 },
    { title: 'วิศวกรรมซอฟต์แวร์', score: 0.76 },
  ],
  5: [
    { title: 'การจัดการโครงการ', score: 0.88 },
    { title: 'IoT และ Embedded Systems', score: 0.82 },
    { title: 'Web Development ด้วย React', score: 0.71 },
  ],
};
// Generate generic recs for books without specific ones
for (const b of BOOKS) {
  if (!RECOMMENDATIONS[b.id]) {
    RECOMMENDATIONS[b.id] = BOOKS.filter(x => x.cat === b.cat && x.id !== b.id).slice(0, 3).map(x => ({
      title: x.title, score: +(0.6 + Math.random() * 0.3).toFixed(2)
    }));
  }
}

// Generate heatmap data (7 days x 12 hours)
function generateHeatmapData(category, faculty) {
  const data = [];
  for (let d = 0; d < 7; d++) {
    const row = [];
    for (let h = 0; h < 12; h++) {
      let base = 10 + Math.random() * 30;
      // Peak hours: 9-11, 13-15
      if (h >= 1 && h <= 3) base *= 1.8;
      if (h >= 5 && h <= 7) base *= 1.5;
      // Weekday boost
      if (d < 5) base *= 1.4;
      // Category multiplier
      if (category === 'it') base *= 1.3;
      if (category === 'education' && (d === 0 || d === 2)) base *= 1.6;
      // Faculty filter reduces a bit
      if (faculty !== 'all') base *= 0.7;
      row.push(Math.round(base));
    }
    data.push(row);
  }
  return data;
}

let heatmapData = generateHeatmapData('all', 'all');

// Monthly data
function generateMonthlyData(category) {
  const months = ['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.'];
  const base = category === 'all' ? 800 : 200;
  return months.map((m, i) => {
    let v = base + Math.random() * 200;
    // Semester peaks
    if (i >= 5 && i <= 9) v *= 1.4;
    if (i === 3) v *= 0.5; // April break
    return { month: m, value: Math.round(v) };
  });
}

// Category totals
function generateCategoryData() {
  return Object.keys(CATEGORIES).map(cat => ({
    cat,
    label: CATEGORIES[cat],
    value: Math.round(500 + Math.random() * 1500),
    color: CAT_COLORS[cat]
  }));
}

// ===== STATE =====
let mqttClient = null;
let selectedBook = null;
let queryCount = 0;
let recsCount = 0;
let insightsCount = 0;
let currentCategory = 'all';
let currentFaculty = 'all';

// ===== HEATMAP DRAWING =====
const hmCanvas = document.getElementById('heatmap');
const hmCtx = hmCanvas.getContext('2d');
const cellW = 48, cellH = 26, offsetX = 70, offsetY = 24;

function drawHeatmap() {
  hmCtx.clearRect(0, 0, hmCanvas.width, hmCanvas.height);

  // Find max value for color scaling
  let maxVal = 0;
  for (const row of heatmapData) for (const v of row) if (v > maxVal) maxVal = v;

  // Draw hour labels
  hmCtx.font = '10px -apple-system, sans-serif';
  hmCtx.fillStyle = '#8b949e';
  hmCtx.textAlign = 'center';
  for (let h = 0; h < 12; h++) {
    hmCtx.fillText(HOURS[h], offsetX + h * cellW + cellW / 2, 16);
  }

  // Draw day labels and cells
  for (let d = 0; d < 7; d++) {
    hmCtx.textAlign = 'right';
    hmCtx.fillStyle = '#8b949e';
    hmCtx.fillText(DAYS_TH[d], offsetX - 8, offsetY + d * cellH + cellH / 2 + 4);

    for (let h = 0; h < 12; h++) {
      const val = heatmapData[d][h];
      const ratio = maxVal > 0 ? val / maxVal : 0;
      const color = heatmapColor(ratio);
      hmCtx.fillStyle = color;
      hmCtx.beginPath();
      hmCtx.roundRect(offsetX + h * cellW + 1, offsetY + d * cellH + 1, cellW - 2, cellH - 2, 3);
      hmCtx.fill();

      // Value text
      hmCtx.fillStyle = ratio > 0.6 ? '#0d1117' : '#8b949e';
      hmCtx.textAlign = 'center';
      hmCtx.font = '10px -apple-system, sans-serif';
      hmCtx.fillText(val, offsetX + h * cellW + cellW / 2, offsetY + d * cellH + cellH / 2 + 4);
    }
  }
}

function heatmapColor(ratio) {
  if (ratio < 0.25) return `rgba(31,58,95,${0.4 + ratio * 2})`;
  if (ratio < 0.5) return `rgba(88,166,255,${0.3 + ratio})`;
  if (ratio < 0.75) return `rgba(251,191,36,${0.5 + ratio * 0.5})`;
  return `rgba(248,113,113,${0.6 + ratio * 0.4})`;
}

// Heatmap click/hover
hmCanvas.addEventListener('mousemove', function(e) {
  const rect = hmCanvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  const col = Math.floor((x - offsetX) / cellW);
  const row = Math.floor((y - offsetY) / cellH);
  const tip = document.getElementById('heatmap-tip');
  if (col >= 0 && col < 12 && row >= 0 && row < 7) {
    const val = heatmapData[row][col];
    tip.style.display = 'block';
    tip.style.left = (e.clientX + 12) + 'px';
    tip.style.top = (e.clientY - 30) + 'px';
    tip.innerHTML = DAYS_TH[row] + ' ' + HOURS[col] + '-' + (9+col) + ':00 — ยืม <strong>' + val + '</strong> เล่ม';
  } else {
    tip.style.display = 'none';
  }
});
hmCanvas.addEventListener('mouseleave', () => {
  document.getElementById('heatmap-tip').style.display = 'none';
});

hmCanvas.addEventListener('click', function(e) {
  const rect = hmCanvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  const col = Math.floor((x - offsetX) / cellW);
  const row = Math.floor((y - offsetY) / cellH);
  if (col >= 0 && col < 12 && row >= 0 && row < 7) {
    const val = heatmapData[row][col];
    addFeedEntry(DAYS_TH[row] + ' ' + HOURS[col], currentCategory === 'all' ? 'ทั้งหมด' : CATEGORIES[currentCategory], val);
    publishQuery(currentCategory, DAYS_TH[row] + ' ' + HOURS[col], val);
  }
});

// ===== CHARTS =====
const catData = generateCategoryData();
const barChart = new Chart(document.getElementById('chart-bar').getContext('2d'), {
  type: 'bar',
  data: {
    labels: catData.map(c => c.label),
    datasets: [{
      data: catData.map(c => c.value),
      backgroundColor: catData.map(c => c.color + '99'),
      borderColor: catData.map(c => c.color),
      borderWidth: 1,
      borderRadius: 4,
    }]
  },
  options: {
    responsive: true, maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    scales: {
      x: { grid: { color: '#21262d' }, ticks: { color: '#8b949e', font: { size: 9 } } },
      y: { grid: { color: '#21262d' }, ticks: { color: '#8b949e', font: { size: 10 } } },
    },
  },
});

const monthlyData = generateMonthlyData('all');
const lineChart = new Chart(document.getElementById('chart-line').getContext('2d'), {
  type: 'line',
  data: {
    labels: monthlyData.map(m => m.month),
    datasets: [{
      label: 'การยืม',
      data: monthlyData.map(m => m.value),
      borderColor: '#58a6ff', backgroundColor: 'rgba(88,166,255,0.1)',
      fill: true, pointRadius: 3, borderWidth: 2, tension: 0.3,
    }]
  },
  options: {
    responsive: true, maintainAspectRatio: false,
    animation: { duration: 500 },
    plugins: { legend: { labels: { color: '#8b949e', font: { size: 10 } } } },
    scales: {
      x: { grid: { color: '#21262d' }, ticks: { color: '#8b949e', font: { size: 10 } } },
      y: { grid: { color: '#21262d' }, ticks: { color: '#8b949e', font: { size: 10 } } },
    },
  },
});

// ===== BOOK LIST =====
function renderBooks(filter) {
  const container = document.getElementById('book-list');
  container.innerHTML = '';
  let filtered = BOOKS;
  if (filter && filter !== 'all') filtered = BOOKS.filter(b => b.cat === filter);
  if (currentFaculty !== 'all') filtered = filtered.filter(b => b.faculty === currentFaculty);
  filtered.sort((a, b) => b.borrows - a.borrows);
  filtered.slice(0, 8).forEach(book => {
    const card = document.createElement('div');
    card.className = 'rec-card' + (selectedBook === book.id ? ' active' : '');
    card.innerHTML = '<div class="title">' + book.title + '</div><div class="meta">' + CATEGORIES[book.cat] + ' — ยืม ' + book.borrows + ' ครั้ง</div>';
    card.onclick = () => selectBook(book.id);
    container.appendChild(card);
  });
}

function selectBook(id) {
  selectedBook = id;
  renderBooks(currentCategory);
  showRecommendations(id);
}

function showRecommendations(id) {
  const panel = document.getElementById('rec-panel');
  const recs = RECOMMENDATIONS[id] || [];
  const book = BOOKS.find(b => b.id === id);
  recsCount += recs.length;
  document.getElementById('s-recs').textContent = recsCount;

  panel.innerHTML = '<div style="font-size:0.8rem; color:#58a6ff; margin-bottom:8px;">นักศึกษาที่ยืม "' + book.title + '" ยังชอบอ่าน:</div>';
  recs.forEach(r => {
    const el = document.createElement('div');
    el.className = 'rec-result';
    el.innerHTML = '<div>' + r.title + '</div><div class="score">similarity: ' + (r.score * 100).toFixed(0) + '%</div>';
    panel.appendChild(el);
  });

  publishQuery(book.cat, 'recommendation', recs.length);
}

// ===== FACULTY TAGS =====
document.getElementById('faculty-tags').addEventListener('click', function(e) {
  const tag = e.target.closest('.faculty-tag');
  if (!tag) return;
  document.querySelectorAll('.faculty-tag').forEach(t => t.classList.remove('active'));
  tag.classList.add('active');
  currentFaculty = tag.dataset.fac;
});

// ===== AI INSIGHTS =====
const AI_INSIGHTS = [
  'เดือนนี้นศ.ยืมหนังสือ IT เพิ่มขึ้น 40% จากเดือนก่อน โดยเฉพาะหมวด AI/ML',
  'พบว่า 68% ของนศ.คณะวิทยาศาสตร์ ยืมหนังสือ IT มากกว่าหนังสือในสาขาตัวเอง',
  'ช่วงเวลา 9:00-11:00 น. เป็น peak hour ของการยืม — มากกว่าช่วงบ่าย 2.3 เท่า',
  'หนังสือ Python สำหรับวิทยาศาสตร์ข้อมูล มี waiting list เฉลี่ย 12 คน ควรจัดซื้อเพิ่ม',
  'พบ pattern: นศ.ที่ยืม ML book มักกลับมายืม Stats book ภายใน 2 สัปดาห์',
  'วันศุกร์มียอดยืมน้อยที่สุด — น้อยกว่า peak day (อังคาร) ถึง 45%',
  'Collaborative filtering ชี้ว่า กลุ่มนศ.วิศวกรรม + วิทยาศาสตร์ มี reading pattern คล้ายกัน',
  'เดือน เม.ย. ยอดยืมลดลง 60% — สอดคล้องกับช่วงปิดเทอม',
];

function generateInsight() {
  const text = AI_INSIGHTS[insightsCount % AI_INSIGHTS.length];
  insightsCount++;
  document.getElementById('s-insights').textContent = insightsCount;

  const panel = document.getElementById('insight-panel');
  const card = document.createElement('div');
  card.className = 'insight-card';
  card.innerHTML = '<div class="icon">AI Insight #' + insightsCount + '</div><div class="text">' + text + '</div>';
  panel.prepend(card);
  if (panel.children.length > 5) panel.lastChild.remove();
}

// ===== APPLY FILTERS =====
window.applyFilters = function() {
  currentCategory = document.getElementById('sel-category').value;
  heatmapData = generateHeatmapData(currentCategory, currentFaculty);
  drawHeatmap();

  // Update bar chart
  const newCatData = generateCategoryData();
  barChart.data.datasets[0].data = newCatData.map(c => c.value);
  barChart.update();

  // Update line chart
  const newMonthly = generateMonthlyData(currentCategory);
  lineChart.data.datasets[0].data = newMonthly.map(m => m.value);
  lineChart.update();

  renderBooks(currentCategory);
  generateInsight();
  queryCount++;
  addFeedEntry('filter', currentCategory === 'all' ? 'ทั้งหมด' : CATEGORIES[currentCategory], '-');
  publishQuery(currentCategory, 'filter', 0);
};

// ===== FEED =====
function addFeedEntry(time, cat, count) {
  const feed = document.getElementById('feed');
  const now = new Date().toLocaleTimeString('th-TH', { hour12: false });
  const el = document.createElement('div');
  el.className = 'feed-entry';
  el.innerHTML = '<span class="ts">' + now + '</span><span class="cat">' + cat + '</span><span class="count">' + count + '</span>';
  feed.prepend(el);
  while (feed.children.length > 20) feed.lastChild.remove();
}

// ===== MQTT =====
function publishQuery(category, timeRange, resultCount) {
  if (mqttClient?.connected) {
    mqttClient.publish('library/query', JSON.stringify({
      category: category,
      time_range: timeRange,
      result_count: resultCount,
      ts: Date.now()
    }));
  }
}

function initMQTT() {
  mqttClient = mqtt.connect(MQTT_BROKER);
  mqttClient.on('connect', () => {
    document.getElementById('dot-mqtt').className = 'dot on';
    document.getElementById('status-mqtt').textContent = 'mqtt: connected';
    mqttClient.subscribe('library/#');
  });
  mqttClient.on('offline', () => {
    document.getElementById('dot-mqtt').className = 'dot off';
    document.getElementById('status-mqtt').textContent = 'mqtt: offline';
  });
}

// ===== INIT =====
drawHeatmap();
renderBooks('all');
generateInsight();
generateInsight();
generateInsight();
initMQTT();

// Auto-refresh insights every 15s
setInterval(generateInsight, 15000);
</script>
</body>
</html>
