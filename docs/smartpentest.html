<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartPenTest — OWASP Vulnerability Scanner</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: #0d1117; color: #e6edf3; font-family: -apple-system, 'Noto Sans Thai', sans-serif; overflow-x: hidden; }

  .layout { display: grid; grid-template-columns: 280px 1fr 300px; gap: 12px; padding: 12px; height: 100vh; }
  @media (max-width: 900px) { .layout { grid-template-columns: 1fr; height: auto; } }

  .panel {
    background: #161b22; border: 1px solid #30363d; border-radius: 12px;
    padding: 16px; overflow-y: auto;
  }
  .panel h2 { color: #58a6ff; font-size: 1rem; margin-bottom: 8px; }
  .panel h3 { color: #8b949e; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin: 12px 0 6px; }

  label.ctrl { display: block; font-size: 0.75rem; color: #8b949e; margin: 8px 0 2px; }
  input[type="text"], input[type="url"] {
    width: 100%; padding: 8px 10px; background: #0d1117; border: 1px solid #30363d;
    border-radius: 6px; color: #e6edf3; font-size: 0.85rem;
  }
  select {
    width: 100%; padding: 8px 10px; background: #0d1117; border: 1px solid #30363d;
    border-radius: 6px; color: #e6edf3; font-size: 0.85rem;
  }

  .start-btn {
    width: 100%; padding: 10px; margin-top: 12px; border: none; border-radius: 8px;
    font-size: 0.9rem; font-weight: 700; cursor: pointer;
  }
  .start-btn.off { background: #3fb950; color: #0d1117; }
  .start-btn.on { background: #f87171; color: #0d1117; }
  .start-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .status-row { display: flex; align-items: center; gap: 6px; margin: 4px 0; font-size: 0.75rem; }
  .dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .dot.on { background: #3fb950; box-shadow: 0 0 4px #3fb950; }
  .dot.off { background: #f87171; }
  .dot.wait { background: #f0883e; animation: pulse 1.5s infinite; }
  @keyframes pulse { 50% { opacity: 0.4; } }

  .glitch-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin: 8px 0; }
  .glitch-btn {
    padding: 8px 6px; border: 1px solid #30363d; border-radius: 6px;
    background: #21262d; color: #8b949e; font-size: 0.7rem; cursor: pointer;
    text-align: center; transition: all 0.15s;
  }
  .glitch-btn:hover { border-color: #58a6ff; }
  .glitch-btn.active { background: #1f3a5f; border-color: #58a6ff; color: #58a6ff; }

  .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 8px 0; }
  .stat-card {
    background: #0d1117; border: 1px solid #30363d; border-radius: 8px;
    padding: 10px; text-align: center;
  }
  .stat-card .num { font-size: 1.4rem; font-weight: 700; }
  .stat-card .lbl { font-size: 0.65rem; color: #8b949e; margin-top: 2px; }
  .stat-card.green .num { color: #3fb950; }
  .stat-card.red .num { color: #f87171; }
  .stat-card.yellow .num { color: #fbbf24; }
  .stat-card.blue .num { color: #58a6ff; }
  .stat-card.orange .num { color: #f0883e; }

  .chart-wrap { position: relative; height: 220px; margin-bottom: 12px; }

  /* Progress bar */
  .progress-container { margin: 12px 0; }
  .progress-bar-bg {
    width: 100%; height: 24px; background: #0d1117; border: 1px solid #30363d;
    border-radius: 12px; overflow: hidden; position: relative;
  }
  .progress-bar-fill {
    height: 100%; border-radius: 12px; transition: width 0.5s ease;
    background: linear-gradient(90deg, #58a6ff, #3fb950);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.7rem; font-weight: 700; color: #0d1117; white-space: nowrap;
    min-width: 0;
  }
  .phase-label { font-size: 0.7rem; color: #8b949e; margin-top: 4px; text-align: center; }

  /* Vuln cards */
  .vuln-list { display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; }
  .vuln-card {
    background: #0d1117; border: 1px solid #30363d; border-radius: 8px;
    padding: 10px; animation: fadeSlide 0.4s ease;
  }
  @keyframes fadeSlide { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
  .vuln-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
  .severity-badge {
    padding: 2px 8px; border-radius: 10px; font-size: 0.65rem; font-weight: 700;
    text-transform: uppercase; color: #0d1117;
  }
  .severity-critical { background: #f87171; }
  .severity-high { background: #f0883e; }
  .severity-medium { background: #fbbf24; }
  .severity-low { background: #58a6ff; }
  .severity-info { background: #8b949e; }
  .owasp-tag { font-size: 0.65rem; color: #8b949e; font-family: monospace; }
  .vuln-desc { font-size: 0.75rem; color: #e6edf3; margin-bottom: 4px; }
  .vuln-url { font-size: 0.65rem; color: #484f58; font-family: monospace; word-break: break-all; }

  /* AI Panel */
  .ai-panel {
    background: #0d1117; border: 1px solid #30363d; border-radius: 8px;
    padding: 12px; margin-top: 8px; min-height: 120px;
  }
  .ai-panel .ai-header { display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
  .ai-panel .ai-icon { font-size: 1rem; }
  .ai-panel .ai-title { font-size: 0.8rem; font-weight: 600; color: #58a6ff; }
  .ai-panel .ai-content { font-size: 0.75rem; color: #e6edf3; line-height: 1.5; }
  .ai-panel .ai-content .typing-cursor { display: inline-block; width: 2px; height: 12px; background: #58a6ff; animation: blink 0.8s infinite; vertical-align: text-bottom; }
  @keyframes blink { 50% { opacity: 0; } }
  .ask-ai-btn {
    padding: 6px 14px; border: 1px solid #58a6ff; border-radius: 6px;
    background: transparent; color: #58a6ff; font-size: 0.75rem; cursor: pointer;
    transition: all 0.15s;
  }
  .ask-ai-btn:hover { background: #1f3a5f; }
  .ask-ai-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  .header {
    grid-column: 1 / -1; display: flex; align-items: center; gap: 12px;
    padding: 8px 16px; background: #161b22; border: 1px solid #30363d; border-radius: 12px;
  }
  .header h1 {
    font-size: 1.2rem;
    background: linear-gradient(135deg, #f87171, #f0883e);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .header .sub { color: #8b949e; font-size: 0.75rem; }
  .header .links { margin-left: auto; font-size: 0.7rem; }
  .header .links a { color: #58a6ff; text-decoration: none; margin-left: 12px; }
</style>
</head>
<body>

<div class="layout">
  <!-- Header -->
  <div class="header">
    <h1>SmartPenTest</h1>
    <span class="sub">OWASP Vulnerability Scanner — AI Analysis</span>
    <div class="links">
      <a href="index.html">Workshop</a>
      <a href="floodboy.html">FloodBoy</a>
      <a href="arena.html">Arena</a>
    </div>
  </div>

  <!-- LEFT: URL Input + Scan Config -->
  <div class="panel" id="controls-panel">
    <h2>Scan Configuration</h2>
    <div class="status-row"><div class="dot wait" id="dot-mqtt"></div><span id="status-mqtt">mqtt: connecting...</span></div>

    <label class="ctrl">Target URL</label>
    <input type="url" id="target-url" value="https://demo.testsite.com" placeholder="https://example.com">

    <label class="ctrl">Scan Profile</label>
    <select id="scan-profile">
      <option value="quick">Quick Scan — เร็ว ตรวจพื้นฐาน</option>
      <option value="standard" selected>Standard — มาตรฐาน OWASP Top 10</option>
      <option value="deep">Deep Scan — ตรวจลึก ใช้เวลานาน</option>
    </select>

    <label class="ctrl">Scan ID</label>
    <input type="text" id="scan-id" value="SCAN001" maxlength="20">

    <h3>Scan Scenario</h3>
    <div class="glitch-grid" id="scenario-grid">
      <button class="glitch-btn active" data-scenario="normal">Normal Scan<br><small>ผลปกติ</small></button>
      <button class="glitch-btn" data-scenario="sqli">SQL Injection<br><small>พบ SQLi</small></button>
      <button class="glitch-btn" data-scenario="xss">XSS Found<br><small>พบ XSS</small></button>
      <button class="glitch-btn" data-scenario="clean">All Clean<br><small>ปลอดภัย</small></button>
      <button class="glitch-btn" data-scenario="overloaded">Server Down<br><small>เซิร์ฟเวอร์ล่ม</small></button>
    </div>

    <button class="start-btn off" id="btn-scan" onclick="startScan()">Start Scan</button>
  </div>

  <!-- CENTER: Scan Progress + Results -->
  <div class="panel">
    <h2>Scan Progress</h2>
    <div class="progress-container">
      <div class="progress-bar-bg">
        <div class="progress-bar-fill" id="progress-fill" style="width: 0%"></div>
      </div>
      <div class="phase-label" id="phase-label">Ready to scan</div>
    </div>

    <h2>Severity Distribution</h2>
    <div class="chart-wrap"><canvas id="chart"></canvas></div>

    <h2>Vulnerabilities Found</h2>
    <div class="vuln-list" id="vuln-list">
      <div style="color:#484f58; font-size:0.75rem; text-align:center; padding:20px;">
        กด Start Scan เพื่อเริ่มสแกน
      </div>
    </div>
  </div>

  <!-- RIGHT: AI Analysis + Stats -->
  <div class="panel">
    <h2>Scan Statistics</h2>
    <div class="stat-grid">
      <div class="stat-card blue"><div class="num" id="s-total">0</div><div class="lbl">Total Vulns</div></div>
      <div class="stat-card red"><div class="num" id="s-critical">0</div><div class="lbl">Critical</div></div>
      <div class="stat-card orange"><div class="num" id="s-high">0</div><div class="lbl">High</div></div>
      <div class="stat-card yellow"><div class="num" id="s-medium">0</div><div class="lbl">Medium</div></div>
      <div class="stat-card blue"><div class="num" id="s-pages">0</div><div class="lbl">Pages Crawled</div></div>
      <div class="stat-card red"><div class="num" id="s-risk">0</div><div class="lbl">Risk Score</div></div>
    </div>

    <h3>AI Security Analysis</h3>
    <div class="ai-panel" id="ai-panel">
      <div class="ai-header">
        <span class="ai-icon">&#x1F916;</span>
        <span class="ai-title">AI Security Advisor</span>
      </div>
      <div class="ai-content" id="ai-content">
        <span style="color:#484f58">เริ่มสแกนเพื่อรับการวิเคราะห์จาก AI</span>
      </div>
    </div>
    <button class="ask-ai-btn" id="btn-ask-ai" onclick="askAI()" disabled>Ask AI — วิเคราะห์เพิ่มเติม</button>

    <h3>OWASP Top 10 Coverage</h3>
    <div id="owasp-coverage" style="font-size:0.7rem; color:#8b949e; margin-top:4px;">
      <div>A01 Broken Access Control — <span id="ow-a01" style="color:#484f58">-</span></div>
      <div>A02 Cryptographic Failures — <span id="ow-a02" style="color:#484f58">-</span></div>
      <div>A03 Injection — <span id="ow-a03" style="color:#484f58">-</span></div>
      <div>A04 Insecure Design — <span id="ow-a04" style="color:#484f58">-</span></div>
      <div>A05 Security Misconfiguration — <span id="ow-a05" style="color:#484f58">-</span></div>
      <div>A06 Vulnerable Components — <span id="ow-a06" style="color:#484f58">-</span></div>
      <div>A07 Auth Failures — <span id="ow-a07" style="color:#484f58">-</span></div>
      <div>A08 Data Integrity — <span id="ow-a08" style="color:#484f58">-</span></div>
      <div>A09 Logging Failures — <span id="ow-a09" style="color:#484f58">-</span></div>
      <div>A10 SSRF — <span id="ow-a10" style="color:#484f58">-</span></div>
    </div>
  </div>
</div>

<script>
// ===== CONSTANTS =====
const MQTT_BROKER = 'wss://dustboy-wss-bridge.laris.workers.dev/mqtt';

// ===== STATE =====
let mqttClient = null;
let scanning = false;
let scenario = 'normal';
let foundVulns = [];
let stats = { total: 0, critical: 0, high: 0, medium: 0, low: 0, info: 0, pages: 0, risk: 0 };

// ===== VULNERABILITY DATABASE =====
const VULN_DB = {
  normal: [
    { severity: 'high', category: 'A03', title: 'SQL Injection — Login Form', desc: 'พบช่องโหว่ SQL Injection ที่หน้า login สามารถ bypass authentication ได้', url: '/login.php?user=admin\'--' },
    { severity: 'medium', category: 'A05', title: 'Server Version Disclosure', desc: 'เซิร์ฟเวอร์เปิดเผยเวอร์ชัน Apache/2.4.41 ใน HTTP headers', url: '/ (Server header)' },
    { severity: 'critical', category: 'A07', title: 'Default Admin Credentials', desc: 'ระบบใช้ username/password เป็น admin/admin ไม่ได้เปลี่ยน', url: '/admin/login' },
    { severity: 'low', category: 'A09', title: 'Missing Security Headers', desc: 'ไม่มี X-Content-Type-Options และ X-Frame-Options headers', url: '/ (Response headers)' },
    { severity: 'medium', category: 'A01', title: 'IDOR — User Profile Access', desc: 'สามารถเข้าถึงโปรไฟล์ผู้ใช้คนอื่นได้โดยเปลี่ยน ID ใน URL', url: '/api/users/123/profile' },
    { severity: 'info', category: 'A05', title: 'Directory Listing Enabled', desc: 'เปิด directory listing ที่โฟลเดอร์ /uploads/', url: '/uploads/' },
  ],
  sqli: [
    { severity: 'critical', category: 'A03', title: 'Blind SQL Injection — Search', desc: 'พบ Blind SQL Injection ที่ช่องค้นหา สามารถดึงข้อมูลทั้ง database ได้ด้วย time-based technique', url: '/search?q=test\' AND SLEEP(5)--' },
    { severity: 'critical', category: 'A03', title: 'Union-based SQLi — Product Page', desc: 'พบ UNION-based SQL Injection สามารถดึง table names, column names, และข้อมูลทั้งหมดได้', url: '/product?id=1 UNION SELECT 1,2,3--' },
    { severity: 'high', category: 'A03', title: 'Error-based SQLi — Login', desc: 'หน้า login แสดง SQL error message เมื่อใส่ single quote เผยโครงสร้าง database', url: '/login.php' },
    { severity: 'high', category: 'A04', title: 'No Parameterized Queries', desc: 'ระบบใช้ string concatenation แทน prepared statements ทั่วทั้งแอป', url: '/api/* (all endpoints)' },
    { severity: 'medium', category: 'A09', title: 'Verbose Error Messages', desc: 'แสดง stack trace และ SQL query ใน error messages', url: '/product?id=abc' },
    { severity: 'critical', category: 'A01', title: 'Authentication Bypass via SQLi', desc: 'สามารถ login เป็น admin ได้ด้วย admin\'-- ไม่ต้องรู้รหัสผ่าน', url: '/login.php?user=admin\'--&pass=x' },
    { severity: 'high', category: 'A02', title: 'Password Stored in Plaintext', desc: 'เมื่อ dump database พบว่ารหัสผ่านเก็บเป็น plaintext ไม่ hash', url: 'users table → password column' },
  ],
  xss: [
    { severity: 'high', category: 'A03', title: 'Reflected XSS — Search Page', desc: 'พบ Reflected XSS ที่ช่องค้นหา สามารถ inject JavaScript เพื่อขโมย cookie ได้', url: '/search?q=<script>alert(1)</script>' },
    { severity: 'critical', category: 'A03', title: 'Stored XSS — Comment Section', desc: 'พบ Stored XSS ที่ช่องแสดงความคิดเห็น script จะทำงานกับผู้ใช้ทุกคนที่เข้าชมหน้านี้', url: '/post/123#comments' },
    { severity: 'high', category: 'A03', title: 'DOM-based XSS — URL Fragment', desc: 'พบ DOM XSS ผ่าน URL fragment ที่ถูกใส่เข้า innerHTML โดยตรง', url: '/page#<img src=x onerror=alert(1)>' },
    { severity: 'medium', category: 'A05', title: 'Missing CSP Header', desc: 'ไม่มี Content-Security-Policy header ทำให้ XSS สามารถโหลด external scripts ได้', url: '/ (Response headers)' },
    { severity: 'medium', category: 'A03', title: 'HTML Injection — Profile Name', desc: 'สามารถใส่ HTML tags ในชื่อโปรไฟล์ แสดงผลบนหน้าอื่นโดยไม่ escape', url: '/profile/edit' },
    { severity: 'low', category: 'A05', title: 'HttpOnly Flag Missing on Session Cookie', desc: 'Cookie ไม่มี HttpOnly flag ทำให้ XSS สามารถอ่าน session cookie ได้', url: '/ (Set-Cookie header)' },
  ],
  clean: [
    { severity: 'info', category: 'A05', title: 'Server Fingerprint', desc: 'ตรวจพบ web server เป็น Nginx แต่ไม่ได้เปิดเผยเวอร์ชัน', url: '/ (Server header)' },
    { severity: 'low', category: 'A09', title: 'Strict-Transport-Security Missing on Subdomain', desc: 'Subdomain บางตัวไม่มี HSTS header แต่ main domain มีแล้ว', url: 'cdn.testsite.com' },
  ],
  overloaded: [
    { severity: 'high', category: 'A05', title: 'Server 503 — Service Unavailable', desc: 'เซิร์ฟเวอร์ตอบ 503 ระหว่างการสแกน อาจมี rate limiting หรือ server overloaded', url: '/ (HTTP 503)' },
    { severity: 'medium', category: 'A05', title: 'Connection Timeout on Deep Paths', desc: 'หลาย URL ตอบช้าเกิน 30 วินาที สแกนไม่สมบูรณ์', url: '/api/admin/*' },
    { severity: 'info', category: 'A05', title: 'WAF Detected — Cloudflare', desc: 'ตรวจพบ Web Application Firewall (Cloudflare) อาจบล็อกบาง scan requests', url: '/ (cf-ray header)' },
  ],
};

// ===== AI EXPLANATIONS =====
const AI_EXPLANATIONS = {
  normal: 'จากการสแกนพบช่องโหว่หลายจุด ที่สำคัญที่สุดคือ Default Admin Credentials (Critical) — ต้องเปลี่ยนรหัสผ่าน admin ทันที เพราะผู้โจมตีสามารถเข้าถึงระบบได้ง่ายมาก\n\nSQL Injection ที่หน้า login ก็อันตรายมาก แนะนำให้ใช้ Prepared Statements แทน string concatenation\n\nสำหรับ IDOR ที่ /api/users ให้เพิ่ม authorization check ทุกครั้งที่เข้าถึงข้อมูลผู้ใช้',
  sqli: 'พบช่องโหว่ SQL Injection ร้ายแรงหลายจุด! นี่คือสถานการณ์ฉุกเฉิน\n\nBlind SQLi + Union SQLi หมายความว่าผู้โจมตีสามารถ:\n- ดึงข้อมูลทั้ง database (username, password, ข้อมูลส่วนตัว)\n- แก้ไข/ลบข้อมูล\n- อาจเข้าถึง OS ของเซิร์ฟเวอร์ได้\n\nวิธีแก้เร่งด่วน:\n1. ใช้ Prepared Statements / Parameterized Queries ทุกจุด\n2. ใช้ ORM แทน raw SQL\n3. ปิด error messages ใน production\n4. Hash รหัสผ่านด้วย bcrypt ทันที',
  xss: 'พบ Cross-Site Scripting (XSS) หลายประเภท — โดยเฉพาะ Stored XSS ที่อันตรายมาก!\n\nStored XSS หมายความว่าผู้โจมตีฝัง script ไว้ใน database แล้ว script จะทำงานกับผู้ใช้ทุกคน สามารถ:\n- ขโมย session cookie → เข้าบัญชีผู้ใช้\n- Redirect ไปหน้า phishing\n- ติดตั้ง keylogger บนหน้าเว็บ\n\nวิธีแก้:\n1. Escape HTML output ทุกจุด (ใช้ library เช่น DOMPurify)\n2. เพิ่ม Content-Security-Policy header\n3. เพิ่ม HttpOnly flag บน session cookie\n4. ใช้ template engine ที่ auto-escape',
  clean: 'สแกนเสร็จสมบูรณ์ ผลลัพธ์ดีมาก!\n\nพบเพียงข้อสังเกตเล็กน้อย ไม่มีช่องโหว่ร้ายแรง เว็บไซต์นี้มีการป้องกันที่ดี มี security headers ครบถ้วน และไม่มี injection vulnerabilities\n\nแนะนำเพิ่มเติม: เพิ่ม HSTS header ให้ครบทุก subdomain',
  overloaded: 'การสแกนไม่สมบูรณ์เนื่องจากเซิร์ฟเวอร์ตอบสนองช้า/ล่ม\n\nอาจเกิดจาก:\n1. Rate limiting / WAF บล็อกการสแกน\n2. เซิร์ฟเวอร์ overloaded จริง\n3. ทรัพยากรไม่เพียงพอ\n\nแนะนำ:\n- ลดความเร็วในการสแกน\n- ขอ whitelist IP จากผู้ดูแลระบบ\n- สแกนนอกเวลาใช้งาน peak',
};

const AI_EXTRA = [
  'เพิ่มเติม: ควรทำ penetration test อย่างน้อยปีละ 2 ครั้ง และหลังจากอัปเดตระบบทุกครั้ง',
  'แนะนำให้ทีมพัฒนาเรียนรู้ OWASP Top 10 ทุกคน เพราะ security เป็นหน้าที่ของทุกคนในทีม ไม่ใช่แค่ security team',
  'ควรตั้ง Security Champions ในแต่ละทีมพัฒนา เพื่อให้มีคนรับผิดชอบเรื่อง security โดยเฉพาะ',
  'ลองใช้ SAST (Static Application Security Testing) เช่น SonarQube ร่วมกับ CI/CD pipeline เพื่อตรวจจับช่องโหว่ตั้งแต่ขั้นตอนเขียนโค้ด',
  'สำหรับ API ควรเพิ่ม rate limiting, input validation, และ authentication ให้ครบทุก endpoint',
];

// ===== SCENARIO BUTTONS =====
document.getElementById('scenario-grid').addEventListener('click', e => {
  const btn = e.target.closest('.glitch-btn');
  if (!btn) return;
  document.querySelectorAll('.glitch-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  scenario = btn.dataset.scenario;
});

// ===== CHART SETUP =====
const ctx = document.getElementById('chart').getContext('2d');
const chart = new Chart(ctx, {
  type: 'doughnut',
  data: {
    labels: ['Critical', 'High', 'Medium', 'Low', 'Info'],
    datasets: [{
      data: [0, 0, 0, 0, 0],
      backgroundColor: ['#f87171', '#f0883e', '#fbbf24', '#58a6ff', '#8b949e'],
      borderColor: '#161b22',
      borderWidth: 3,
    }],
  },
  options: {
    responsive: true, maintainAspectRatio: false,
    cutout: '60%',
    plugins: {
      legend: { position: 'bottom', labels: { color: '#8b949e', font: { size: 10 }, boxWidth: 12, padding: 8 } },
    },
  },
});

// ===== SCAN PHASES =====
const PHASES = [
  { label: 'Reconnaissance — สำรวจเป้าหมาย', duration: 1500 },
  { label: 'Spider — ค้นหา URL ทั้งหมด', duration: 2000 },
  { label: 'Active Scan — ทดสอบช่องโหว่', duration: 3000 },
  { label: 'Analysis — วิเคราะห์ผลลัพธ์', duration: 1500 },
];

// ===== START SCAN =====
window.startScan = async function() {
  if (scanning) return;
  scanning = true;
  const btn = document.getElementById('btn-scan');
  btn.textContent = 'Scanning...';
  btn.className = 'start-btn on';
  btn.disabled = true;

  // Reset state
  foundVulns = [];
  stats = { total: 0, critical: 0, high: 0, medium: 0, low: 0, info: 0, pages: 0, risk: 0 };
  updateStats();
  chart.data.datasets[0].data = [0, 0, 0, 0, 0];
  chart.update();
  document.getElementById('vuln-list').innerHTML = '';
  document.getElementById('ai-content').innerHTML = '<span style="color:#484f58">Scanning...</span>';
  document.getElementById('btn-ask-ai').disabled = true;

  // Reset OWASP coverage
  for (let i = 1; i <= 10; i++) {
    document.getElementById('ow-a' + (i < 10 ? '0' + i : i)).textContent = '-';
    document.getElementById('ow-a' + (i < 10 ? '0' + i : i)).style.color = '#484f58';
  }

  const vulns = VULN_DB[scenario] || VULN_DB.normal;
  let progress = 0;
  const totalDuration = PHASES.reduce((a, p) => a + p.duration, 0);

  // Run phases
  for (const phase of PHASES) {
    document.getElementById('phase-label').textContent = phase.label;
    const steps = 20;
    const stepDur = phase.duration / steps;
    const stepPct = (phase.duration / totalDuration * 100) / steps;

    for (let i = 0; i < steps; i++) {
      progress += stepPct;
      document.getElementById('progress-fill').style.width = Math.min(progress, 100) + '%';
      document.getElementById('progress-fill').textContent = Math.round(progress) + '%';

      // Randomly add pages crawled
      if (Math.random() < 0.3) {
        stats.pages += Math.floor(Math.random() * 3) + 1;
        updateStats();
      }

      await sleep(stepDur);
    }

    // Add vulns during Active Scan phase
    if (phase.label.includes('Active Scan')) {
      for (let v = 0; v < vulns.length; v++) {
        await sleep(300 + Math.random() * 400);
        addVuln(vulns[v]);
      }
    }
  }

  // Complete
  document.getElementById('progress-fill').style.width = '100%';
  document.getElementById('progress-fill').textContent = '100%';
  document.getElementById('phase-label').textContent = 'Scan complete';

  // Calculate risk score
  stats.risk = Math.min(100, stats.critical * 30 + stats.high * 15 + stats.medium * 5 + stats.low * 1);
  updateStats();

  // Show AI analysis
  await typeAI(AI_EXPLANATIONS[scenario] || AI_EXPLANATIONS.normal);
  document.getElementById('btn-ask-ai').disabled = false;

  // Publish summary via MQTT
  if (mqttClient?.connected) {
    const scanId = document.getElementById('scan-id').value;
    mqttClient.publish('pentest/' + scanId + '/summary', JSON.stringify({
      url: document.getElementById('target-url').value,
      scenario, total: stats.total, critical: stats.critical,
      high: stats.high, medium: stats.medium, risk: stats.risk,
    }));
  }

  btn.textContent = 'Start Scan';
  btn.className = 'start-btn off';
  btn.disabled = false;
  scanning = false;
};

function addVuln(vuln) {
  foundVulns.push(vuln);
  stats.total++;
  stats[vuln.severity]++;

  // Update chart
  const sevMap = { critical: 0, high: 1, medium: 2, low: 3, info: 4 };
  chart.data.datasets[0].data[sevMap[vuln.severity]]++;
  chart.update();

  // Update OWASP coverage
  const owNum = vuln.category.replace('A', '');
  const owEl = document.getElementById('ow-a' + owNum);
  if (owEl) {
    const sevColors = { critical: '#f87171', high: '#f0883e', medium: '#fbbf24', low: '#58a6ff', info: '#8b949e' };
    owEl.textContent = vuln.severity.toUpperCase();
    owEl.style.color = sevColors[vuln.severity];
  }

  // Add card
  const list = document.getElementById('vuln-list');
  if (stats.total === 1) list.innerHTML = '';
  const card = document.createElement('div');
  card.className = 'vuln-card';
  card.innerHTML =
    '<div class="vuln-header">' +
      '<span class="severity-badge severity-' + vuln.severity + '">' + vuln.severity + '</span>' +
      '<span class="owasp-tag">' + vuln.category + '</span>' +
      '<span style="color:#e6edf3; font-size:0.8rem; font-weight:600;">' + vuln.title + '</span>' +
    '</div>' +
    '<div class="vuln-desc">' + vuln.desc + '</div>' +
    '<div class="vuln-url">' + escapeHtml(vuln.url) + '</div>';
  list.appendChild(card);

  // Publish via MQTT
  if (mqttClient?.connected) {
    const scanId = document.getElementById('scan-id').value;
    mqttClient.publish('pentest/' + scanId + '/result', JSON.stringify({
      url: document.getElementById('target-url').value,
      severity: vuln.severity, category: vuln.category, description: vuln.title,
    }));
  }

  updateStats();
}

function escapeHtml(text) {
  const d = document.createElement('div');
  d.textContent = text;
  return d.innerHTML;
}

// ===== AI TYPING =====
async function typeAI(text) {
  const el = document.getElementById('ai-content');
  el.innerHTML = '';
  const lines = text.split('\n');
  let fullHtml = '';
  for (const line of lines) {
    for (let i = 0; i < line.length; i++) {
      fullHtml += line[i];
      el.innerHTML = fullHtml + '<span class="typing-cursor"></span>';
      await sleep(15 + Math.random() * 15);
    }
    fullHtml += '<br>';
    el.innerHTML = fullHtml + '<span class="typing-cursor"></span>';
    await sleep(100);
  }
  el.innerHTML = fullHtml;
}

window.askAI = async function() {
  const btn = document.getElementById('btn-ask-ai');
  btn.disabled = true;
  const extra = AI_EXTRA[Math.floor(Math.random() * AI_EXTRA.length)];
  await typeAI(extra);
  btn.disabled = false;
};

function updateStats() {
  document.getElementById('s-total').textContent = stats.total;
  document.getElementById('s-critical').textContent = stats.critical;
  document.getElementById('s-high').textContent = stats.high;
  document.getElementById('s-medium').textContent = stats.medium;
  document.getElementById('s-pages').textContent = stats.pages;
  document.getElementById('s-risk').textContent = stats.risk;
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ===== MQTT =====
function initMQTT() {
  mqttClient = mqtt.connect(MQTT_BROKER);
  mqttClient.on('connect', () => {
    document.getElementById('dot-mqtt').className = 'dot on';
    document.getElementById('status-mqtt').textContent = 'mqtt: connected';
  });
  mqttClient.on('offline', () => {
    document.getElementById('dot-mqtt').className = 'dot off';
    document.getElementById('status-mqtt').textContent = 'mqtt: offline';
  });
}

// ===== INIT =====
initMQTT();
</script>
</body>
</html>