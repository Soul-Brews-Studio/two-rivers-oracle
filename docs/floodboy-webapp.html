<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FloodBoy Webapp - JIBCHAIN L1</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js and Date Adapter -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#3B82F6', secondary: '#10B981' }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #334155;
        }

        .fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 50;
            background: white;
            padding: 20px;
        }
    </style>
</head>

<body>
    <!-- Overlay Loader -->
    <div id="loadingOverlay"
        class="fixed inset-0 bg-white/90 z-50 flex flex-col justify-center items-center backdrop-blur-sm hidden">
        <div class="relative w-24 h-24 mb-6">
            <div class="absolute inset-0 rounded-full border-t-4 border-primary border-solid animate-spin"></div>
            <div
                class="absolute inset-2 rounded-full border-r-4 border-secondary border-solid animate-[spin_1.5s_linear_infinite_reverse]">
            </div>
            <div
                class="absolute inset-4 rounded-full border-b-4 border-blue-400 border-solid animate-[spin_2s_linear_infinite]">
            </div>
            <i
                class="fa-solid fa-water absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-2xl text-primary"></i>
        </div>
        <h2 class="text-xl font-semibold text-gray-700 font-inter">Loading FloodBoy Data...</h2>
        <p id="loadingStatusText" class="text-gray-500 mt-2">Connecting to JIBCHAIN L1 Smart Contracts</p>
    </div>

    <!-- Top Navigation -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-50 p-2 rounded-lg"><i class="fa-solid fa-droplet text-primary"></i></div>
                    <span class="font-bold text-xl text-gray-900 tracking-tight">FloodBoy Webapp</span>
                </div>
                <div class="flex items-center gap-3">
                    <select id="storeSelector"
                        class="bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-primary focus:border-primary block w-48 p-2 font-medium">
                        <option value="0x0994Bc66b2863f8D58C8185b1ed6147895632812">FloodBoy016 Store</option>
                        <option value="0xCd3Ec17ddFDa24f8F97131fa0FDf20e7cbd1A8Bb">FloodBoy001 Store</option>
                    </select>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6">

        <!-- Header Section -->
        <div
            class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden flex flex-col md:flex-row divide-y md:divide-y-0 md:divide-x divide-gray-100">
            <div class="p-8 flex-1">
                <div class="flex items-center gap-2 text-sm font-semibold text-blue-600 mb-3 tracking-wide uppercase">
                    <i class="fa-solid fa-satellite-dish animate-pulse"></i> Latest Sensor Data
                </div>
                <h2 id="storeNickname" class="text-3xl font-bold text-gray-900 mb-2 truncate">FloodBoy Monitor</h2>
                <p id="storeDesc" class="text-gray-500 text-lg line-clamp-2">Connecting to sensors...</p>
                <div class="mt-4 flex flex-wrap gap-2 text-sm">
                    <span class="inline-flex items-center px-3 py-1 rounded-full bg-blue-50 text-blue-700 font-medium">
                        <i class="fa-regular fa-clock mr-1.5"></i> Last Updated: <span id="lastUpdated"
                            class="ml-1">-</span>
                    </span>
                    <span
                        class="inline-flex items-center px-3 py-1 rounded-full bg-green-50 text-green-700 font-medium">
                        <i class="fa-solid fa-link mr-1.5"></i> Current Block: <span id="currentBlock"
                            class="ml-1">-</span>
                    </span>
                    <a id="storeLink" href="#" target="_blank"
                        class="inline-flex items-center px-3 py-1 rounded-full bg-gray-50 text-gray-700 hover:bg-gray-100 transition font-mono border border-gray-200">
                        <span id="storeAddrTrunc">-</span> <i
                            class="fa-solid fa-arrow-up-right-from-square ml-1.5 text-xs text-gray-400"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- UI Toggles Section -->
        <div class="flex flex-wrap gap-4 items-center p-4 bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="flex items-center gap-2 border-r border-gray-200 pr-4">
                <button id="toggleTableBtn"
                    class="px-4 py-2 rounded-md text-sm font-semibold shadow-sm bg-white text-gray-700 ring-1 ring-gray-200 hover:bg-gray-50">
                    <i class="fa-solid fa-table mr-2 text-gray-400"></i> Data Table
                </button>
                <button id="toggleChartBtn"
                    class="px-4 py-2 rounded-md text-sm font-semibold shadow-sm bg-blue-50 text-primary ring-1 ring-blue-200">
                    <i class="fa-solid fa-chart-line mr-2 text-blue-400"></i> Analytics Chart
                </button>
            </div>

            <div class="flex items-center gap-2 border-r border-gray-200 pr-4">
                <span class="text-sm font-medium text-gray-500">Interval:</span>
                <select id="intervalSelector"
                    class="bg-gray-50 border border-gray-200 text-gray-700 text-sm rounded-lg focus:ring-primary p-2">
                    <option value="30">30 Minutes</option>
                    <option value="60">1 Hour</option>
                    <option value="360">6 Hours</option>
                    <option value="1440">24 Hours</option>
                </select>
            </div>

            <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-gray-500">Metric:</span>
                <button id="toggleWater"
                    class="px-4 py-2 rounded-md text-sm font-semibold shadow-sm bg-white text-primary ring-1 ring-gray-200">Water
                    Depth</button>
                <button id="toggleBattery"
                    class="px-4 py-2 rounded-md text-sm font-semibold text-gray-500 hover:text-gray-700 border border-transparent">Battery
                    Voltage</button>
            </div>

            <button id="fullscreenBtn" class="ml-auto px-4 py-2 text-sm text-gray-500 hover:text-gray-800 transition">
                <i class="fa-solid fa-expand mr-1"></i> Fullscreen Chart
            </button>
        </div>

        <!-- System Alerts -->
        <div id="alertContainer"
            class="hidden mb-4 p-4 rounded-lg bg-yellow-50 border border-yellow-200 text-yellow-800 flex items-center gap-3">
            <i class="fa-solid fa-circle-exclamation text-yellow-600"></i>
            <span id="alertMessage">No historical data available.</span>
        </div>

        <!-- Chart Section -->
        <div id="chartSection"
            class="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm relative transition-all">
            <h3 id="chartTitle" class="text-xl font-bold text-gray-800 mb-4">Historical Data Over Time</h3>
            <div class="relative w-full h-[450px]">
                <canvas id="mainChart"></canvas>
            </div>
            <button id="exitFullscreenBtn"
                class="hidden absolute top-4 right-4 bg-gray-800 text-white px-3 py-1.5 rounded-md hover:bg-gray-700 shadow flex items-center gap-2">
                <i class="fa-solid fa-compress"></i> Exit
            </button>
        </div>

        <!-- Data Table Section -->
        <div id="tableSection" class="hidden px-2 py-2">
            <h3 class="text-xl font-bold text-gray-800 mb-4 px-2">Data Table View (24h)</h3>
            <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-sm">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600 text-sm border-b border-gray-200">
                            <th class="px-6 py-4 font-semibold w-1/4">Metric</th>
                            <th class="px-6 py-4 font-semibold">Current</th>
                            <th class="px-6 py-4 font-semibold">Min (24h)</th>
                            <th class="px-6 py-4 font-semibold">Max (24h)</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="divide-y divide-gray-100 bg-white">
                        <tr>
                            <td colspan="4" class="px-6 py-8 text-center text-gray-500">Loading data metrics...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Footer -->
        <div
            class="px-8 py-6 bg-slate-50 border border-gray-200 rounded-xl text-sm text-gray-500 grid md:grid-cols-2 gap-4">
            <div>
                <p class="mb-1"><span class="font-medium text-gray-700">Last Updated:</span> <span
                        id="footerLastSync">-</span></p>
                <p><span class="font-medium text-gray-700">Sensor Count:</span> <span id="footerSensorCount">-</span>
                    authorized sensor</p>
            </div>
            <div class="md:text-right">
                <p class="mb-1">
                    <span class="font-medium text-gray-700">Store Owner:</span>
                    <a id="ownerLink" href="#" target="_blank" class="font-mono text-primary hover:underline">-</a>
                </p>
                <p>
                    <span class="font-medium text-gray-700">Deployed Block:</span>
                    <a id="blockLink" href="#" target="_blank" class="font-mono text-primary hover:underline">-</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Application Logic -->
    <script type="module">
        import { createPublicClient, http } from 'https://esm.sh/viem@2.8.0';

        // Viem Configurations
        const jibchain = {
            id: 8899,
            name: 'JIBCHAIN L1',
            rpcUrls: { default: { http: ['https://rpc-l1.jibchain.net'] } }
        };

        const client = createPublicClient({ chain: jibchain, transport: http() });

        const FACTORY_ADDRESS = '0x63bB41b79b5aAc6e98C7b35Dcb0fE941b85Ba5Bb';
        const UNIVERSAL_SIGNER = '0xcB0e58b011924e049ce4b4D62298Edf43dFF0BDd';

        const factoryABI = [{ "name": "getStoreInfo", "inputs": [{ "name": "store", "type": "address" }], "outputs": [{ "name": "nickname", "type": "string" }, { "name": "owner", "type": "address" }, { "name": "authorizedSensorCount", "type": "uint256" }, { "name": "deployedBlock", "type": "uint128" }, { "name": "description", "type": "string" }], "stateMutability": "view", "type": "function" }];

        const storeABI = [
            { "name": "getAllFields", "outputs": [{ "components": [{ "name": "name", "type": "string" }, { "name": "unit", "type": "string" }, { "name": "dtype", "type": "string" }], "type": "tuple[]" }], "stateMutability": "view", "type": "function" },
            { "name": "getLatestRecord", "inputs": [{ "name": "sensor", "type": "address" }], "outputs": [{ "name": "", "type": "uint256" }, { "name": "", "type": "int256[]" }], "stateMutability": "view", "type": "function" },
            { "anonymous": false, "inputs": [{ "indexed": true, "name": "sensor", "type": "address" }, { "indexed": false, "name": "timestamp", "type": "uint256" }, { "indexed": false, "name": "values", "type": "int256[]" }], "name": "RecordStored", "type": "event" }
        ];

        let currentChart = null;
        let activeDatasetType = 'waterDepth';
        let cachedEvents = [];
        let fieldConfigs = [];
        let currentRecordVals = [];

        const loadingOverlay = document.getElementById('loadingOverlay');
        const storeSelector = document.getElementById('storeSelector');
        const intervalSelector = document.getElementById('intervalSelector');

        // Critical Unit Conversion Math as per rules: x10000 -> /10000, x1000 -> /1000, x100 -> /100
        function processValue(value, unit) {
            const baseUnit = unit.replace(/ x\d+/, '');
            const num = Number(value);
            if (unit.includes('x10000')) return (num / 10000).toFixed(4) + ' ' + baseUnit;
            if (unit.includes('x1000')) return (num / 1000).toFixed(3) + ' ' + baseUnit;
            if (unit.includes('x100')) return (num / 100).toFixed(3) + ' ' + baseUnit;
            return value + ' ' + baseUnit;
        }

        function processRawValue(value, unit) {
            const num = Number(value);
            if (unit.includes('x10000')) return num / 10000;
            if (unit.includes('x1000')) return num / 1000;
            if (unit.includes('x100')) return num / 100;
            return num;
        }

        // Title Case exact formatting
        function formatFieldName(fieldName, sampleCount = null) {
            let name = fieldName.split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');

            // "Water Depth ([X] samples)" format instead of "count"
            if (fieldName.toLowerCase() === 'water_depth' && sampleCount !== null) {
                name = `${name} (${sampleCount} samples)`;
            }
            return name;
        }

        function truncateAddr(addr) {
            if (!addr) return '';
            return `${addr.substring(0, 10)}...${addr.substring(addr.length - 6)}`;
        }

        async function initApp() {
            try {
                loadingOverlay.classList.remove('hidden');
                document.getElementById('dataTableBody').innerHTML = '<tr><td colspan="4" class="px-6 py-8 text-center text-gray-500">Loading data metrics...</td></tr>';
                if (currentChart) { currentChart.destroy(); currentChart = null; }

                const storeAddr = storeSelector.value;
                document.getElementById('storeLink').href = `https://exp-l1.jibchain.net/address/${storeAddr}`;
                document.getElementById('storeAddrTrunc').textContent = truncateAddr(storeAddr);

                const currentBlockNum = await client.getBlockNumber();
                document.getElementById('currentBlock').textContent = Number(currentBlockNum).toLocaleString();

                const [nickname, owner, sensorCount, deployedBlock, description] = await client.readContract({
                    address: FACTORY_ADDRESS, abi: factoryABI, functionName: 'getStoreInfo', args: [storeAddr]
                });

                document.getElementById('storeNickname').textContent = nickname;
                document.getElementById('storeDesc').textContent = description;
                document.getElementById('footerSensorCount').textContent = Number(sensorCount);
                document.getElementById('ownerLink').textContent = truncateAddr(owner);
                document.getElementById('ownerLink').href = `https://exp-l1.jibchain.net/address/${owner}`;
                document.getElementById('blockLink').textContent = `#${Number(deployedBlock).toLocaleString()}`;
                document.getElementById('blockLink').href = `https://exp-l1.jibchain.net/block/${deployedBlock}`;

                fieldConfigs = await client.readContract({
                    address: storeAddr, abi: storeABI, functionName: 'getAllFields'
                });

                const latestRes = await client.readContract({
                    address: storeAddr, abi: storeABI, functionName: 'getLatestRecord', args: [UNIVERSAL_SIGNER]
                });

                const lastTimestamp = latestRes[0];
                currentRecordVals = latestRes[1];

                const dateSync = new Date(Number(lastTimestamp) * 1000);
                const timeStr = dateSync.toLocaleString('en-US', { timeStyle: 'medium', dateStyle: 'short' });
                document.getElementById('lastUpdated').textContent = timeStr;
                document.getElementById('footerLastSync').textContent = timeStr;

                loadingOverlay.classList.add('hidden');

                document.getElementById('alertMessage').innerHTML = `<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Loading historical data to build charts...`;
                document.getElementById('alertContainer').classList.remove('hidden');
                document.getElementById('alertContainer').className = "mb-4 p-4 rounded-lg bg-blue-50 border border-blue-200 text-blue-800 flex items-center";

                // Fetch data over approximately 7 days max to ensure we capture the large sample sizes.
                // 1 day is ~28,800 blocks. 7 days is ~201,600 blocks.
                let fetchFrom = Number(deployedBlock);
                if (Number(currentBlockNum) - fetchFrom > 201600) {
                    fetchFrom = Number(currentBlockNum) - 201600;
                }

                cachedEvents = [];
                const CHUNK_SIZE = 1999n;
                const totalChunks = Math.ceil((Number(currentBlockNum) - fetchFrom) / Number(CHUNK_SIZE));
                let fetchCount = 0;

                for (let start = BigInt(fetchFrom); start <= currentBlockNum; start += CHUNK_SIZE) {
                    let end = start + CHUNK_SIZE - 1n;
                    if (end > currentBlockNum) end = currentBlockNum;

                    fetchCount++;
                    document.getElementById('alertMessage').innerHTML = `<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Fetching historical block chunks (${fetchCount}/${totalChunks})...`;

                    try {
                        const chunkEvents = await client.getContractEvents({
                            address: storeAddr,
                            abi: storeABI,
                            eventName: 'RecordStored',
                            fromBlock: start,
                            toBlock: end,
                            args: { sensor: UNIVERSAL_SIGNER }
                        });

                        if (chunkEvents.length > 0) {
                            cachedEvents.push(...chunkEvents);
                            cachedEvents.sort((a, b) => Number(a.args.timestamp) - Number(b.args.timestamp));
                            updateTableWithHistory();
                            updateChart();
                        }
                    } catch (e) {
                        console.warn(`Failed to fetch events for blocks ${start}-${end}:`, e);
                    }
                }

                document.getElementById('alertContainer').classList.add('hidden');
                document.getElementById('alertContainer').className = "hidden mb-4 p-4 rounded-lg bg-yellow-50 border border-yellow-200 text-yellow-800 flex items-center gap-3";

            } catch (err) {
                console.error("Initialization Failed:", err);
                loadingOverlay.classList.add('hidden');
                document.getElementById('dataTableBody').innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-red-500 font-medium">Failed to load data: ${err.message}</td></tr>`;
                document.getElementById('alertMessage').textContent = `Loading failed: ${err.message}`;
                document.getElementById('alertContainer').classList.remove('hidden');
            }
        }

        function updateTableWithHistory() {
            const minMaxData = fieldConfigs.map(() => ({ min: Infinity, max: -Infinity }));
            cachedEvents.forEach(evt => {
                evt.args.values.forEach((v, idx) => {
                    const num = Number(v);
                    if (num < minMaxData[idx].min) minMaxData[idx].min = num;
                    if (num > minMaxData[idx].max) minMaxData[idx].max = num;
                });
            });

            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            let parity = false;
            const sampleCount = cachedEvents.length;

            fieldConfigs.forEach((field, index) => {
                // Hide purely min/max specific generic log fields if they exist
                if (field.name.includes('min') || field.name.includes('max')) return;

                // Add exact sample count to the water depth metric name
                const fName = formatFieldName(field.name, field.name === 'water_depth' ? sampleCount : null);

                const curVal = currentRecordVals[index] !== undefined ? processValue(currentRecordVals[index], field.unit) : 'N/A';
                const minVal = minMaxData[index].min !== Infinity ? processValue(minMaxData[index].min, field.unit) : 'N/A';
                const maxVal = minMaxData[index].max !== -Infinity ? processValue(minMaxData[index].max, field.unit) : 'N/A';

                parity = !parity;
                const bColor = parity ? 'bg-white' : 'bg-gray-50/50';

                const row = `
                    <tr class="${bColor} hover:bg-blue-50/50 transition-colors">
                        <td class="px-6 py-4 font-medium text-gray-900 border-r border-gray-100">${fName}</td>
                        <td class="px-6 py-4 font-mono text-primary font-semibold">${curVal}</td>
                        <td class="px-6 py-4 font-mono text-gray-600 border-l border-gray-100">${minVal}</td>
                        <td class="px-6 py-4 font-mono text-gray-600">${maxVal}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function updateChart() {
            if (cachedEvents.length === 0) return;

            const isWater = activeDatasetType === 'waterDepth';
            const searchTag = isWater ? 'water_depth' : 'battery_voltage';

            const dataIndex = fieldConfigs.findIndex(f => f.name.toLowerCase() === searchTag);
            if (dataIndex === -1) return;

            const targetField = fieldConfigs[dataIndex];
            const baseUnit = targetField.unit.replace(/ x\d+/, '');

            // Data Grouping Interval from Select Dropdown
            const intervalMins = parseInt(intervalSelector.value, 10) || 30;
            const BUCKET_MS = intervalMins * 60 * 1000;
            const buckets = new Map();

            cachedEvents.forEach(evt => {
                const ts = Number(evt.args.timestamp) * 1000;
                const bucketTime = Math.floor(ts / BUCKET_MS) * BUCKET_MS;
                const val = processRawValue(evt.args.values[dataIndex], targetField.unit);

                if (!buckets.has(bucketTime)) {
                    buckets.set(bucketTime, { sum: 0, count: 0 });
                }
                const b = buckets.get(bucketTime);
                b.sum += val;
                b.count += 1;
            });

            const points = Array.from(buckets.entries())
                .sort((a, b) => a[0] - b[0])
                .map(([time, data]) => ({ x: new Date(time), y: data.sum / data.count }));

            const color = isWater ? '#3B82F6' : '#10B981';
            const bgColor = isWater ? 'rgba(59, 130, 246, 0.1)' : 'rgba(16, 185, 129, 0.1)';
            const title = isWater ? `Water Depth Over Time (${intervalMins}m Avg)` : `Battery Voltage Over Time (${intervalMins}m Avg)`;

            document.getElementById('chartTitle').textContent = title;

            // Strict Y-Axis Bound Calcs to prevent overstretching
            const minChartY = isWater ? Math.min(...points.map(p => p.y)) * 0.99 : Math.min(...points.map(p => p.y)) - 0.2;
            const maxChartY = isWater ? Math.max(...points.map(p => p.y)) * 1.01 : Math.max(...points.map(p => p.y)) + 0.2;

            if (currentChart) {
                currentChart.data.datasets[0].data = points;
                currentChart.data.datasets[0].label = isWater ? `Water Depth (${baseUnit})` : `Voltage (${baseUnit})`;
                currentChart.data.datasets[0].borderColor = color;
                currentChart.data.datasets[0].backgroundColor = bgColor;
                currentChart.options.scales.y.suggestedMin = minChartY;
                currentChart.options.scales.y.suggestedMax = maxChartY;
                currentChart.update('none'); // Update without full reload
            } else {
                const ctx = document.getElementById('mainChart').getContext('2d');
                currentChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: isWater ? `Water Depth (${baseUnit})` : `Voltage (${baseUnit})`,
                            data: points,
                            borderColor: color,
                            backgroundColor: bgColor,
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: points.length > 50 ? 0 : 3,
                            pointHoverRadius: 6,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                titleColor: '#1e293b',
                                bodyColor: '#1e293b',
                                borderColor: '#e2e8f0',
                                borderWidth: 1,
                                padding: 12,
                                callbacks: {
                                    label: function (context) { return ` ${Number(context.parsed.y).toFixed(isWater ? 4 : 3)} ${baseUnit}`; }
                                }
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: { tooltipFormat: 'MMM d, yyyy h:mm a' },
                                grid: { display: false },
                                ticks: { maxTicksLimit: 8, font: { family: "'Inter', sans-serif" } }
                            },
                            y: {
                                grid: { color: '#f1f5f9' },
                                ticks: {
                                    font: { family: "'Inter', sans-serif" },
                                    callback: function (value) { return Number(value).toFixed(isWater ? 4 : 3) + ' ' + baseUnit; }
                                },
                                suggestedMin: minChartY,
                                suggestedMax: maxChartY,
                            }
                        }
                    }
                });
            }
        }

        // View Toggles
        const btnWater = document.getElementById('toggleWater');
        const btnBattery = document.getElementById('toggleBattery');
        const btnTable = document.getElementById('toggleTableBtn');
        const btnChart = document.getElementById('toggleChartBtn');
        const tableSec = document.getElementById('tableSection');
        const chartSec = document.getElementById('chartSection');

        // Fullscreen
        const fBtn = document.getElementById('fullscreenBtn');
        const extFBtn = document.getElementById('exitFullscreenBtn');
        let isFS = false;

        function setToggleState(type) {
            activeDatasetType = type;
            if (type === 'waterDepth') {
                btnWater.className = 'px-4 py-2 rounded-md text-sm font-semibold shadow-sm bg-blue-50 text-primary ring-1 ring-blue-200';
                btnBattery.className = 'px-4 py-2 rounded-md text-sm font-semibold text-gray-500 hover:text-gray-700 hover:bg-gray-50 transition border border-transparent';
            } else {
                btnBattery.className = 'px-4 py-2 rounded-md text-sm font-semibold shadow-sm bg-green-50 text-secondary ring-1 ring-green-200';
                btnWater.className = 'px-4 py-2 rounded-md text-sm font-semibold text-gray-500 hover:text-gray-700 hover:bg-gray-50 transition border border-transparent';
            }
            updateChart();
        }

        function toggleView(view) {
            if (view === 'table') {
                tableSec.classList.remove('hidden');
                chartSec.classList.add('hidden');
                btnTable.className = 'px-4 py-2 rounded-md text-sm font-semibold shadow-sm bg-blue-50 text-primary ring-1 ring-blue-200';
                btnChart.className = 'px-4 py-2 rounded-md text-sm font-semibold text-gray-500 hover:text-gray-700 hover:bg-gray-50 transition border border-transparent';
            } else {
                tableSec.classList.add('hidden');
                chartSec.classList.remove('hidden');
                btnChart.className = 'px-4 py-2 rounded-md text-sm font-semibold shadow-sm bg-blue-50 text-primary ring-1 ring-blue-200';
                btnTable.className = 'px-4 py-2 rounded-md text-sm font-semibold text-gray-500 hover:text-gray-700 hover:bg-gray-50 transition border border-transparent';
            }
        }

        fBtn.addEventListener('click', () => {
            isFS = true;
            chartSec.classList.add('fullscreen');
            extFBtn.classList.remove('hidden');
            if (currentChart) currentChart.resize();
        });

        extFBtn.addEventListener('click', () => {
            isFS = false;
            chartSec.classList.remove('fullscreen');
            extFBtn.classList.add('hidden');
            if (currentChart) currentChart.resize();
        });

        btnWater.addEventListener('click', () => setToggleState('waterDepth'));
        btnBattery.addEventListener('click', () => setToggleState('batteryVoltage'));
        btnTable.addEventListener('click', () => toggleView('table'));
        btnChart.addEventListener('click', () => toggleView('chart'));

        intervalSelector.addEventListener('change', () => updateChart()); // Just recalculate chart quickly on bucket change
        storeSelector.addEventListener('change', () => initApp());

        // Setup init layout
        setToggleState('waterDepth');
        toggleView('chart');

        // Initial Load
        window.addEventListener('load', () => { setTimeout(() => initApp(), 200) })
    </script>
</body>

</html>